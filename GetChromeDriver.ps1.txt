# ==========================
# Configurable target folder
# ==========================
$targetFolder = "C:\WebDrivers\ChromeDriver"
$chromeDriverPath = Join-Path $targetFolder "chromedriver.exe"
$tempZip = "$env:TEMP\chromedriver.zip"

# ==========================
# 1) Get installed Chrome version
# ==========================
$chromePath = "${env:ProgramFiles(x86)}\Google\Chrome\Application\chrome.exe"
if (-not (Test-Path $chromePath)) {
    $chromePath = "${env:ProgramFiles}\Google\Chrome\Application\chrome.exe"
}

if (-not (Test-Path $chromePath)) {
    Write-Host "❌ Google Chrome not found at default paths."
    exit 1
}

$chromeVersion = (Get-Item $chromePath).VersionInfo.ProductVersion
Write-Host "Google Chrome version detected: $chromeVersion"

# ==========================
# 2) Check if existing driver matches
# ==========================
$needsDownload = $true
$chromeMajor = $chromeVersion.Split('.')[0]

if (Test-Path $chromeDriverPath) {
    try {
        $existingDriverVersion = (Get-Item $chromeDriverPath).VersionInfo.ProductVersion
    } catch {
        $existingDriverVersion = $null
    }
    Write-Host "Existing ChromeDriver version detected: $existingDriverVersion"

    if ($existingDriverVersion -and ($existingDriverVersion -eq $chromeVersion)) {
        Write-Host "✅ ChromeDriver version matches Chrome. No download needed."
        $needsDownload = $false
    } else {
        Write-Host "⚠️ ChromeDriver version mismatch. Will find correct one."
    }
} else {
    Write-Host "ℹ️ ChromeDriver not found. Will download."
}

# ==========================
# 3) Download & extract if needed
# ==========================
if ($needsDownload) {

    if (-not (Test-Path $targetFolder)) {
        New-Item -ItemType Directory -Path $targetFolder | Out-Null
    }

    # Fetch Chrome-for-Testing known versions JSON
    $jsonUrl = "https://googlechromelabs.github.io/chrome-for-testing/known-good-versions-with-downloads.json"
    Write-Host "Fetching Chrome-for-Testing version index..."
    try {
        $jsonData = Invoke-RestMethod -Uri $jsonUrl -UseBasicParsing -ErrorAction Stop
    } catch {
        Write-Host "❌ Failed to fetch Chrome version index."
        exit 1
    }

    # Find best match for installed Chrome version (match on major)
    $versions = $jsonData.versions | Where-Object { $_.version -like "$chromeMajor.*" }

    if (-not $versions) {
        Write-Host "❌ Could not find compatible ChromeDriver for version $chromeVersion"
        exit 1
    }

    # Get the highest available patch for that major
    $latestMatch = $versions[-1]  # last item is the newest
    $driverVersion = $latestMatch.version
    $zipUrl = $latestMatch.downloads.chromedriver | Where-Object { $_.platform -eq "win64" } | Select-Object -ExpandProperty url

    Write-Host "Latest compatible ChromeDriver: $driverVersion"
    Write-Host "Downloading from: $zipUrl"

    try {
        Invoke-WebRequest -Uri $zipUrl -OutFile $tempZip -UseBasicParsing -ErrorAction Stop
        Write-Host "Download complete. Extracting..."

        Expand-Archive -Path $tempZip -DestinationPath $targetFolder -Force

        $extractedDir = Join-Path $targetFolder "chromedriver-win64"
        if (Test-Path $extractedDir) {
            Get-ChildItem -Path $extractedDir -Force | Move-Item -Destination $targetFolder -Force
            Remove-Item -Recurse -Force $extractedDir
        }

        Remove-Item $tempZip -Force
        Write-Host "✅ ChromeDriver updated successfully to version $driverVersion"
    }
    catch {
        Write-Host "❌ Failed to download ChromeDriver from: $zipUrl"
        Write-Host "Visit https://googlechromelabs.github.io/chrome-for-testing/ to download manually."
    }
}
